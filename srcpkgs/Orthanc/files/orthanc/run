#!/bin/sh
OPTS=""
[ -r conf ] && . ./conf

: ${USER:="_orthanc"}

: ${CONFIGFILE:="/etc/orthanc/Configuration.json"}
[ -r "$CONFIGFILE" ] || exit 1

: ${ORTHANCSTORAGE:="/var/lib/OrthancStorage"}
if [ ! -e "$ORTHANCSTORAGE" ]
then
	mkdir -pm 0750 "$ORTHANCSTORAGE" &&
	chown ${USER}:${USER} "$ORTHANCSTORAGE" ||
	exit 1
fi

# Enable log
if [ -n "$LOG" ]; then
	: ${LOGDIR:="/var/log/orthanc"}
	LOGDIR_OPT="--logdir=$LOGDIR"

	if [ ! -e "$LOGDIR" ]; then
		mkdir -pm 0750 "$LOGDIR" &&
		chown ${USER}:${USER} "$LOGDIR" ||
		exit 1
	fi
fi

# Set OPTS on conf file for aditional parameters
exec chpst -u ${USER}:${USER} Orthanc $OPTS "$LOGDIR_OPT" "$CONFIGFILE"
