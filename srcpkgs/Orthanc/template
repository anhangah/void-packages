# Template file for 'Orthanc'
pkgname=Orthanc
version=1.11.3
revision=1
build_wrksrc="OrthancServer"
build_style=cmake
configure_args="-DALLOW_DOWNLOADS=ON -DSTATIC_BUILD=OFF
 -DBoost_NO_BOOST_CMAKE=ON -DDCMTK_DIR=/usr/lib/cmake/dcmtk"
hostmakedepends="python3 unzip tar doxygen dcmtk"
makedepends="libuuid-devel boost-devel libcurl-devel
 libdcmtk-devel gtest-devel libpng-devel libjpeg-turbo-devel
 sqlite-devel libcivetweb-devel openssl-devel jsoncpp-devel lua-devel
 pugixml-devel"
depends="dcmtk"
short_desc="Lightweight RESTful DICOM server"
maintainer="Carlos E. Gallo F. <gcarlos@disroot.org>"
license="GPL-3.0-or-later"
homepage="https://www.orthanc-server.com/index.php"
distfiles="https://www.orthanc-server.com/downloads/get.php?path=/orthanc/Orthanc-${version}.tar.gz"
checksum=103ef5d57f8e8ae2db35e74503172d42c6e1f4e528512c555118efe14ebc077b
python_version=3
nocross="A package on makedepends (dcmtk) is marked as nocross"

# Create '_orthanc' user for the server
system_accounts="_orthanc"
_orthanc_descr="Orthanc server user"

conf_files="/etc/orthanc/Configuration.json"

post_install() {
	vsv orthanc
	vinstall Resources/Configuration.json 0644 etc/orthanc

	cd ${DESTDIR}
	mv usr/sbin/* usr/bin/
	rm -rf usr/sbin

	mkdir -p usr/lib/orthanc/plugins
	mv usr/share/orthanc/plugins/* usr/lib/orthanc/plugins/
	rm -rf usr/share/orthanc/plugins

	# Remove garbage
	rm -rf builddir
}

Orthanc-devel_package() {
	depends+=" ${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/share/doc
		vmkdir usr/share/orthanc/OrthancFramework 0755
		vcopy ${wrksrc}/OrthancFramework usr/share/orthanc
	}
}

Orthanc-plugins_package() {
	depends+=" ${sourcepkg}>=${version}_${revision}"
	short_desc+=" - official plugins"
	pkg_install() {
		vmove usr/lib/orthanc/plugins
	}
}
